
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crimson Cue Standings</title>
    <style>
        :root {
            --felt-green: #0a5d3e;
            --felt-dark: #07422c;
            --wood-brown: #3e2723;
            --text-color: #333;
        }

        body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; display: flex; flex-direction: column; align-items: center; padding: 20px;
            /* Pool-table felt background */
            /* SVG green felt background (data URI) */
            background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='200' height='120'><rect width='100%25' height='100%25' fill='%230b5d3f'/><g opacity='0.06'><rect width='100%25' height='100%25' fill='white'/></g></svg>");
            background-color: #0b5d3f;
            background-size: cover;
        }

        /* Wood frame around the container */
        .table-frame {
            width: 100%;
            max-width: 920px;
            padding: 14px; /* frame thickness */
            border-radius: 14px;
            /* SVG wood grain background (data URI) */
            background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='800' height='120' viewBox='0 0 800 120'><defs><linearGradient id='g' x1='0' x2='0'><stop offset='0' stop-color='%235b3421'/><stop offset='1' stop-color='%233c1f14'/></linearGradient></defs><rect width='100%25' height='100%25' fill='url(%23g)'/><g opacity='0.06' fill='rgba(255,255,255,0.06)'><rect x='0' y='10' width='800' height='4'/><rect x='0' y='50' width='800' height='3'/></g></svg>");
            box-shadow: 0 8px 30px rgba(0,0,0,0.5), inset 0 -6px 18px rgba(0,0,0,0.25);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        /* inner wrapper for header frame */
        .table-frame .frame-inner { width: 100%; max-width: 900px; }

        /* Slight inner bevel to simulate rail inset */
        .table-frame::after {
            content: '';
            position: absolute;
            pointer-events: none;
        }

        .table-frame .container {
            width: 100%;
            max-width: 900px;
            background: white;
            border-radius: 0 0 8px 8px;
            padding: 18px;
            box-shadow: inset 0 2px 0 rgba(255,255,255,0.3), 0 6px 20px rgba(0,0,0,0.2);
        }
        header { background-color: var(--felt-green); color: white; width: 100%; max-width: 900px; padding: 18px; text-align: center; border-radius: 8px 8px 0 0; border-bottom: 5px solid var(--wood-brown); }
        .container { background: white; width: 100%; max-width: 900px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-radius: 0 0 8px 8px; }
        h2 { color: var(--felt-green); border-bottom: 2px solid #eee; padding-bottom: 10px; }

        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th { background-color: var(--felt-green); color: white; padding: 12px; text-align: left; }
        td { padding: 12px; border-bottom: 1px solid #ddd; }
        #table-body tr { cursor: pointer; }
        #table-body tr:not(.podium):hover { background-color: #f1f1f1; }

        /* Updated Modal Styles */
        #modal-overlay { 
            display: none; 
            position: fixed; 
            top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.8); 
            z-index: 100; 
        }
        
        .modal-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            border-bottom: 2px solid var(--felt-green); 
            padding-bottom: 6px;
            margin-bottom: 6px;
            flex-shrink: 0; /* Prevents header from squishing */
        }
        
        #schedule-modal {
            display: none;
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 12px 16px;
            border-radius: 12px;
            z-index: 101;
            width: 90%;
            max-width: 400px;
            
            height: auto;
            max-height: 70vh; 
            display: flex;
            flex-direction: column;
            /* Keep modal container visible so the internal scroll container can scroll */
            overflow: visible;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        
        .modal-scroll-container {
            /* Force this box to scroll if content exceeds the space. */
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            flex: 1 1 auto; 
            min-height: 0; /* Crucial for flexbox scrolling */
            margin-top: 0;
            border: 1px solid #eee;
            /* Limit the inner scroll area so it fits within the modal's max-height */
            max-height: calc(70vh - 100px);
            position: relative; /* helps position:sticky inside this scrolling context */
        }
        
        #modal-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        /* Tighter spacing so more rows fit in the modal */
        #modal-table th {
            position: sticky;
            top: 0; /* stick to top of the scroll container */
            background-color: var(--felt-green);
            color: white;
            padding: 8px 6px;
            z-index: 10;
            font-size: 13px;
            line-height: 1.15;
        }

        #modal-table td {
            padding: 6px 6px;
            border-bottom: 1px solid #f0f0f0;
            line-height: 1.15;
            font-size: 13px;
            vertical-align: middle;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Win/Loss coloring */
        .win { color: var(--felt-green); font-weight: 600; }
        .loss { color: #d32f2f; font-weight: 600; }

        /* Podium styling for top 3 rows */
        #table-body tr.podium { color: #111; }
        #table-body tr.podium-1 { background: linear-gradient(90deg,#fff7d6,#ffe39b); font-weight:700; }
        #table-body tr.podium-2 { background: linear-gradient(90deg,#f0f0f0,#d7d7d7); font-weight:700; }
        #table-body tr.podium-3 { background: linear-gradient(90deg,#f5e6da,#e0b38a); font-weight:700; }

        /* Medal inline SVG styling */
        .medal { display: inline-flex; align-items: center; margin-right: 6px; }
        .medal svg { width: 1.15em; height: 1.15em; display: block; }
    </style>
</head>
<body>

    <div class="table-frame">
        <div class="frame-inner">
            <header><h1 style="margin:0;">Crimson Cue</h1></header>
        </div>
    </div>

    <div class="table-frame">
        <div class="container">
            <h2>League Standings</h2>
            <div id="loader" class="loading">Fetching league data...</div>
            <table id="standings-table" style="display:none;">
                <thead><tr id="table-header"></tr></thead>
                <tbody id="table-body"></tbody>
            </table>
        </div>
    </div>
    <div id="modal-overlay" onclick="closeModal()"></div>
    <div id="schedule-modal">
        <div class="modal-header">
            <h3 id="modal-title" style="margin:0;">Player Schedule</h3>
            <span style="cursor:pointer; font-size: 1.5rem;" onclick="closeModal()">Ã—</span>
        </div>
        <div class="modal-scroll-container"> <table id="modal-table">
                <thead>
                    <tr>
                        <th>Week</th>
                        <th>Opponent</th>
                        <th>Result</th>
                    </tr>
                </thead>
                <tbody id="modal-body"></tbody>
            </table>
        </div>
    </div>

    <script>
        const standingsUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT7I8Vhws-a0KiVfiAzXZFneeKXAAJj51zqtjOf9h2AOHh51RWfZwyFCMtWU6VpckdXYVpGj8l0fPRv/pub?gid=2132397504&single=true&output=csv';
        const scheduleUrl  = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT7I8Vhws-a0KiVfiAzXZFneeKXAAJj51zqtjOf9h2AOHh51RWfZwyFCMtWU6VpckdXYVpGj8l0fPRv/pub?gid=1315791574&single=true&output=csv';
        const playersUrl   = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT7I8Vhws-a0KiVfiAzXZFneeKXAAJj51zqtjOf9h2AOHh51RWfZwyFCMtWU6VpckdXYVpGj8l0fPRv/pub?gid=1493303522&single=true&output=csv';

        let scheduleData = [];
        let playersData = [];

        // Helper to interpret various truthy values in CSV (e.g., '1', 'TRUE')
        function truthy(val) {
            if (!val && val !== 0) return false;
            const s = String(val).trim().toLowerCase();
            return s === '1' || s === 'true' || s === 'yes' || s === 'y' || s === 't';
        }

        // SVG medal icons (inline markup)
        const medalSVG = {
            gold: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true"><defs><radialGradient id="g1"><stop offset="0" stop-color="#fffacd"/><stop offset="1" stop-color="#ffd24d"/></radialGradient></defs><circle cx="12" cy="8" r="5" fill="url(%23g1)" stroke="#c39200" stroke-width="0.8"/><rect x="9" y="12" width="6" height="8" fill="#c39200"/></svg>',
            silver: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true"><defs><linearGradient id="g2" x1="0" x2="0"><stop offset="0" stop-color="#ffffff"/><stop offset="1" stop-color="#cfcfcf"/></linearGradient></defs><circle cx="12" cy="8" r="5" fill="url(%23g2)" stroke="#9a9a9a" stroke-width="0.8"/><rect x="9" y="12" width="6" height="8" fill="#9a9a9a"/></svg>',
            bronze: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true"><defs><linearGradient id="g3" x1="0" x2="0"><stop offset="0" stop-color="#fff1e6"/><stop offset="1" stop-color="#d99a6a"/></linearGradient></defs><circle cx="12" cy="8" r="5" fill="url(%23g3)" stroke="#a86b3d" stroke-width="0.8"/><rect x="9" y="12" width="6" height="8" fill="#a86b3d"/></svg>'
        };

        async function init() {
            try {
                const [stR, schR, plR] = await Promise.all([fetch(standingsUrl), fetch(scheduleUrl), fetch(playersUrl)]);
                const stText = await stR.text();
                const schText = await schR.text();
                const plText = await plR.text();

                const stRows = stText.split('\n').map(r => r.split(','));
                scheduleData = schText.split('\n').map(r => r.split(','));
                playersData = plText.split('\n').map(r => r.split(','));

                renderStandings(stRows);
                // Ensure modal is hidden on initial load (prevent accidental open)
                const overlay = document.getElementById('modal-overlay');
                const modalEl = document.getElementById('schedule-modal');
                if (overlay) overlay.style.display = 'none';
                if (modalEl) modalEl.style.display = 'none';
            } catch (e) {
                document.getElementById('loader').textContent = "Error loading data.";
            }
        }

        function renderStandings(rows) {
            const tableHeader = document.getElementById('table-header');
            const tableBody = document.getElementById('table-body');
            
            // Header
            rows[0].forEach(h => {
                let th = document.createElement('th');
                th.textContent = h;
                tableHeader.appendChild(th);
            });

            // Rows (standings now: Rank, PlayerName, Record, SOR)
            rows.slice(1).forEach((row, i) => {
                if (row.length < 2) return;
                let tr = document.createElement('tr');
                // apply podium classes for top 3 rows
                if (i === 0) tr.classList.add('podium', 'podium-1');
                else if (i === 1) tr.classList.add('podium', 'podium-2');
                else if (i === 2) tr.classList.add('podium', 'podium-3');
                // player name is now the second column
                tr.onclick = () => openSchedule((row[1] || '').trim());
                row.forEach((cell, ci) => {
                    let td = document.createElement('td');
                    if (ci === 0 && i < 3) {
                        // prepend medal SVG and then the cell text
                        const wrap = document.createElement('span');
                        wrap.className = 'medal';
                        wrap.innerHTML = (i === 0 ? medalSVG.gold : (i === 1 ? medalSVG.silver : medalSVG.bronze));
                        td.appendChild(wrap);
                        td.appendChild(document.createTextNode(cell));
                    } else {
                        td.textContent = cell;
                    }
                    tr.appendChild(td);
                });
                tableBody.appendChild(tr);
            });

            document.getElementById('loader').style.display = 'none';
            document.getElementById('standings-table').style.display = 'table';
        }

        function openSchedule(playerName) {
            const modalBody = document.getElementById('modal-body');
            const scrollContainer = document.querySelector('.modal-scroll-container');
            document.getElementById('modal-title').textContent = playerName + "'s History";
            modalBody.innerHTML = '';

            // 1. Find ID from Name
            const pEntry = playersData.find(r => r[1] && r[1].trim() === playerName);
            if (!pEntry) return;
            const targetID = pEntry[0].trim();

            // 2. ID to Name Map
            const idMap = {};
            playersData.forEach(r => { if(r[0]) idMap[r[0].trim()] = r[1]; });

            // 3. Filter Schedule
            scheduleData.slice(1).forEach(game => {
                let [week, p1ID, p2ID, p1win, proc] = game.map(c => c ? c.trim() : "");
                if (p1ID === targetID || p2ID === targetID) {
                    const isP1 = (p1ID === targetID);
                    const oppName = idMap[isP1 ? p2ID : p1ID] || "Unknown";
                    let res = 'TBD';
                    if (truthy(proc)) {
                        const p1W = truthy(p1win);
                        // use boolean comparison: if player is p1 and p1W true => win
                        res = (isP1 === p1W) ? '<span class="win">W</span>' : '<span class="loss">L</span>';
                    }
                    let tr = document.createElement('tr');
                    tr.innerHTML = `<td>${week}</td><td title="${oppName}">${oppName}</td><td>${res}</td>`;
                    modalBody.appendChild(tr);
                }
            });

            // Show modal first so layout/scrolling is established, then reset scroll position
            document.getElementById('modal-overlay').style.display = 'block';
            document.getElementById('schedule-modal').style.display = 'block';
            // ensure scroll is at top on next frame after modal is visible
            requestAnimationFrame(() => {
                if (scrollContainer) {
                    scrollContainer.scrollTop = 0;
                    scrollContainer.scrollTo({ top: 0 });
                }
                const modalEl = document.getElementById('schedule-modal');
                if (modalEl) modalEl.scrollTop = 0;
            });
        }

        function closeModal() {
            document.getElementById('modal-overlay').style.display = 'none';
            document.getElementById('schedule-modal').style.display = 'none';
        }

        init();
    </script>
</body>
</html>
