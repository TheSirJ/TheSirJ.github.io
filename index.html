
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crimson Cue Standings</title>
    <style>
        :root {
            --felt-green: #0a5d3e;
            --felt-dark: #07422c;
            --wood-brown: #3e2723;
            --text-color: #333;
        }

        body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; display: flex; flex-direction: column; align-items: center; padding: 20px;
            /* Pool-table felt background */
            background-color: #0b5d3f;
            /* stronger felt texture: tighter repeating lines + subtle diagonal micro-stripe */
            background-image:
                repeating-linear-gradient(0deg, rgba(255,255,255,0.03) 0 1px, transparent 1px 4px),
                repeating-linear-gradient(45deg, rgba(255,255,255,0.015) 0 1px, transparent 1px 6px),
                linear-gradient(180deg, rgba(0,0,0,0.05), rgba(255,255,255,0.02));
            background-size: 100% 3px, 6px 6px, auto;
            background-blend-mode: overlay, overlay;
        }

        /* Wood frame around the container */
        .table-frame {
            width: 100%;
            max-width: 920px;
            padding: 14px; /* frame thickness */
            border-radius: 14px;
            background: linear-gradient(180deg,#5b3421,#3c1f14); /* wood base */
            box-shadow: 0 8px 30px rgba(0,0,0,0.5), inset 0 -6px 18px rgba(0,0,0,0.25);
            display: flex;
            justify-content: center;
        }

        /* Slight inner bevel to simulate rail inset */
        .table-frame::after {
            content: '';
            position: absolute;
            pointer-events: none;
        }

        .table-frame .container {
            width: 100%;
            max-width: 900px;
            background: white;
            border-radius: 8px;
            padding: 18px;
            box-shadow: inset 0 2px 0 rgba(255,255,255,0.3), 0 6px 20px rgba(0,0,0,0.2);
        }
        /* Separate wooden outline specifically for the header graphic */
        .header-wood { display: block; width: 100%; max-width: 920px; margin: 0 auto 18px; padding: 14px; border-radius: 14px; background: linear-gradient(180deg,#5b3421,#3c1f14); box-shadow: 0 6px 18px rgba(0,0,0,0.35), inset 0 -4px 10px rgba(255,255,255,0.03); }
        .header-wood header { display: block; border-radius: 8px; overflow: hidden; }
        header { background-color: white; color: var(--wood-brown); width: 100%; box-sizing: border-box; max-width: none; padding: 18px 18px 24px 18px; text-align: center; border-radius: 8px 8px 0 0; border-bottom: 5px solid var(--felt-green); margin: 0 0 -12px 0; }
        .container { background: white; width: 100%; max-width: 900px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-radius: 0 0 8px 8px; }
        h2 { color: var(--felt-green); border-bottom: 2px solid #eee; padding-bottom: 10px; }

        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th { background-color: var(--felt-green); color: white; padding: 12px; text-align: left; }
        td { padding: 12px; border-bottom: 1px solid #ddd; }
        #table-body tr { cursor: pointer; }
        #table-body tr:not(.podium):hover { background-color: #f1f1f1; }

        /* Updated Modal Styles */
        #modal-overlay { 
            display: none; 
            position: fixed; 
            top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.8); 
            z-index: 100; 
        }
        
        .modal-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            border-bottom: 2px solid var(--felt-green); 
            padding-bottom: 6px;
            margin-bottom: 6px;
            flex-shrink: 0; /* Prevents header from squishing */
        }
        
        #schedule-modal {
            display: none;
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 12px 16px;
            border-radius: 12px;
            z-index: 101;
            width: 90%;
            max-width: 400px;
            
            height: auto;
            max-height: 70vh; 
            display: flex;
            flex-direction: column;
            /* Keep modal container visible so the internal scroll container can scroll */
            overflow: visible;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        
        .modal-scroll-container {
            /* Force this box to scroll if content exceeds the space. */
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            flex: 1 1 auto; 
            min-height: 0; /* Crucial for flexbox scrolling */
            margin-top: 0;
            border: 1px solid #eee;
            /* Limit the inner scroll area so it fits within the modal's max-height */
            max-height: calc(70vh - 100px);
            position: relative; /* helps position:sticky inside this scrolling context */
        }
        
        #modal-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        /* Tighter spacing so more rows fit in the modal */
        #modal-table th {
            position: sticky;
            top: 0; /* stick to top of the scroll container */
            background-color: var(--felt-green);
            color: white;
            padding: 8px 6px;
            z-index: 10;
            font-size: 13px;
            line-height: 1.15;
        }

        #modal-table td {
            padding: 6px 6px;
            border-bottom: 1px solid #f0f0f0;
            line-height: 1.15;
            font-size: 13px;
            vertical-align: middle;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Win/Loss coloring */
        .win { color: var(--felt-green); font-weight: 600; }
        .loss { color: #d32f2f; font-weight: 600; }

        /* Podium styling for top 3 rows */
        #table-body tr.podium { color: #111; }
        #table-body tr.podium-1 { background: linear-gradient(90deg,#fff7d6,#ffe39b); font-weight:700; }
        #table-body tr.podium-2 { background: linear-gradient(90deg,#f0f0f0,#d7d7d7); font-weight:700; }
        #table-body tr.podium-3 { background: linear-gradient(90deg,#f5e6da,#e0b38a); font-weight:700; }

        /* Medal icons before the first cell of each podium row */
        #table-body tr.podium-1 td:first-child::before { content: "ðŸ¥‡ "; margin-right:6px; font-size:1.05em; }
        #table-body tr.podium-2 td:first-child::before { content: "ðŸ¥ˆ "; margin-right:6px; font-size:1.05em; }
        #table-body tr.podium-3 td:first-child::before { content: "ðŸ¥‰ "; margin-right:6px; font-size:1.05em; }
    </style>
</head>
<body>

    <div class="header-wood"><header><h1 style="margin:0;">Crimson Cue</h1></header></div>

    <div class="table-frame">
    <div class="container">
        <h2>League Standings</h2>
        <div id="loader" class="loading">Fetching league data...</div>
        <table id="standings-table" style="display:none;">
            <thead><tr id="table-header"></tr></thead>
            <tbody id="table-body"></tbody>
        </table>
    </div>
    </div>
    <div id="modal-overlay" onclick="closeModal()"></div>
    <div id="schedule-modal">
        <div class="modal-header">
            <h3 id="modal-title" style="margin:0;">Player Schedule</h3>
            <span style="cursor:pointer; font-size: 1.5rem;" onclick="closeModal()">Ã—</span>
        </div>
        <div class="modal-scroll-container"> <table id="modal-table">
                <thead>
                    <tr>
                        <th>Week</th>
                        <th>Opponent</th>
                        <th>Result</th>
                    </tr>
                </thead>
                <tbody id="modal-body"></tbody>
            </table>
        </div>
    </div>

    <script>
        const standingsUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT7I8Vhws-a0KiVfiAzXZFneeKXAAJj51zqtjOf9h2AOHh51RWfZwyFCMtWU6VpckdXYVpGj8l0fPRv/pub?gid=2132397504&single=true&output=csv';
        const scheduleUrl  = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT7I8Vhws-a0KiVfiAzXZFneeKXAAJj51zqtjOf9h2AOHh51RWfZwyFCMtWU6VpckdXYVpGj8l0fPRv/pub?gid=1315791574&single=true&output=csv';
        const playersUrl   = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT7I8Vhws-a0KiVfiAzXZFneeKXAAJj51zqtjOf9h2AOHh51RWfZwyFCMtWU6VpckdXYVpGj8l0fPRv/pub?gid=1493303522&single=true&output=csv';

        let scheduleData = [];
        let playersData = [];

        // Helper to interpret various truthy values in CSV (e.g., '1', 'TRUE')
        function truthy(val) {
            if (!val && val !== 0) return false;
            const s = String(val).trim().toLowerCase();
            return s === '1' || s === 'true' || s === 'yes' || s === 'y' || s === 't';
        }

        async function init() {
            try {
                const [stR, schR, plR] = await Promise.all([fetch(standingsUrl), fetch(scheduleUrl), fetch(playersUrl)]);
                const stText = await stR.text();
                const schText = await schR.text();
                const plText = await plR.text();

                const stRows = stText.split('\n').map(r => r.split(','));
                scheduleData = schText.split('\n').map(r => r.split(','));
                playersData = plText.split('\n').map(r => r.split(','));

                renderStandings(stRows);
                // Ensure modal is hidden on initial load (prevent accidental open)
                const overlay = document.getElementById('modal-overlay');
                const modalEl = document.getElementById('schedule-modal');
                if (overlay) overlay.style.display = 'none';
                if (modalEl) modalEl.style.display = 'none';
            } catch (e) {
                document.getElementById('loader').textContent = "Error loading data.";
            }
        }

        function renderStandings(rows) {
            const tableHeader = document.getElementById('table-header');
            const tableBody = document.getElementById('table-body');
            
            // Header
            rows[0].forEach(h => {
                let th = document.createElement('th');
                th.textContent = h;
                tableHeader.appendChild(th);
            });

            // Rows
            rows.slice(1).forEach((row, i) => {
                if (row.length < 2) return;
                let tr = document.createElement('tr');
                // apply podium classes for top 3 rows
                if (i === 0) tr.classList.add('podium', 'podium-1');
                else if (i === 1) tr.classList.add('podium', 'podium-2');
                else if (i === 2) tr.classList.add('podium', 'podium-3');
                tr.onclick = () => openSchedule(row[1].trim());
                row.forEach(cell => {
                    let td = document.createElement('td');
                    td.textContent = cell;
                    tr.appendChild(td);
                });
                tableBody.appendChild(tr);
            });

            document.getElementById('loader').style.display = 'none';
            document.getElementById('standings-table').style.display = 'table';
        }

        function openSchedule(playerName) {
            const modalBody = document.getElementById('modal-body');
            const scrollContainer = document.querySelector('.modal-scroll-container');
            document.getElementById('modal-title').textContent = playerName + "'s Schedule";
            modalBody.innerHTML = '';

            // 1. Find ID from Name
            const pEntry = playersData.find(r => r[1] && r[1].trim() === playerName);
            if (!pEntry) return;
            const targetID = pEntry[0].trim();

            // 2. ID to Name Map
            const idMap = {};
            playersData.forEach(r => { if(r[0]) idMap[r[0].trim()] = r[1]; });

            // 3. Filter Schedule
            scheduleData.slice(1).forEach(game => {
                let [week, p1ID, p2ID, p1win, proc] = game.map(c => c ? c.trim() : "");
                if (p1ID === targetID || p2ID === targetID) {
                    const isP1 = (p1ID === targetID);
                    const oppName = idMap[isP1 ? p2ID : p1ID] || "Unknown";
                    let res = 'TBD';
                    if (truthy(proc)) {
                        const p1W = truthy(p1win);
                        // use boolean comparison: if player is p1 and p1W true => win
                        res = (isP1 === p1W) ? '<span class="win">W</span>' : '<span class="loss">L</span>';
                    }
                    let tr = document.createElement('tr');
                    tr.innerHTML = `<td>${week}</td><td title="${oppName}">${oppName}</td><td>${res}</td>`;
                    modalBody.appendChild(tr);
                }
            });

            // Show modal first so layout/scrolling is established, then reset scroll position
            document.getElementById('modal-overlay').style.display = 'block';
            document.getElementById('schedule-modal').style.display = 'block';
            // ensure scroll is at top on next frame after modal is visible
            requestAnimationFrame(() => {
                if (scrollContainer) {
                    scrollContainer.scrollTop = 0;
                    scrollContainer.scrollTo({ top: 0 });
                }
                const modalEl = document.getElementById('schedule-modal');
                if (modalEl) modalEl.scrollTop = 0;
            });
        }

        function closeModal() {
            document.getElementById('modal-overlay').style.display = 'none';
            document.getElementById('schedule-modal').style.display = 'none';
        }

        init();
    </script>
</body>
</html>
