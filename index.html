const standingsUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT7I8Vhws-a0KiVfiAzXZFneeKXAAJj51zqtjOf9h2AOHh51RWfZwyFCMtWU6VpckdXYVpGj8l0fPRv/pub?gid=2132397504&single=true&output=csv';
const scheduleUrl  = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT7I8Vhws-a0KiVfiAzXZFneeKXAAJj51zqtjOf9h2AOHh51RWfZwyFCMtWU6VpckdXYVpGj8l0fPRv/pub?gid=1315791574&single=true&output=csv';
const playersUrl   = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT7I8Vhws-a0KiVfiAzXZFneeKXAAJj51zqtjOf9h2AOHh51RWfZwyFCMtWU6VpckdXYVpGj8l0fPRv/pub?gid=1493303522&single=true&output=csv';

let scheduleData = [];
let playersData = [];

async function init() {
    try {
        // Fetch all three data sources simultaneously
        const [stResp, schResp, plResp] = await Promise.all([
            fetch(standingsUrl),
            fetch(scheduleUrl),
            fetch(playersUrl)
        ]);

        const stText = await stResp.text();
        const schText = await schResp.text();
        const plText = await plResp.text();

        // Parse CSVs
        const standingsRows = stText.split('\n').map(row => row.split(','));
        scheduleData = schText.split('\n').map(row => row.split(','));
        playersData = plText.split('\n').map(row => row.split(','));

        renderStandings(standingsRows);
    } catch (e) {
        console.error("Initialization failed", e);
        document.getElementById('loader').textContent = "Error loading data.";
    }
}

function renderStandings(rows) {
    const tableHeader = document.getElementById('table-header');
    const tableBody = document.getElementById('table-body');
    const table = document.getElementById('standings-table');

    // 1. Headers
    rows[0].forEach(text => {
        let th = document.createElement('th');
        th.textContent = text;
        tableHeader.appendChild(th);
    });

    // 2. Rows
    rows.slice(1).forEach(row => {
        if (row.length < 2) return;
        let tr = document.createElement('tr');
        
        // When clicked, pass the Player Name to the lookup function
        tr.onclick = () => openSchedule(row[0].trim());

        row.forEach(cell => {
            let td = document.createElement('td');
            td.textContent = cell;
            tr.appendChild(td);
        });
        tableBody.appendChild(tr);
    });

    document.getElementById('loader').style.display = 'none';
    table.style.display = 'table';
}

function openSchedule(playerName) {
    const modalBody = document.getElementById('modal-body');
    const modalTitle = document.getElementById('modal-title');
    modalBody.innerHTML = '';
    modalTitle.textContent = `${playerName}'s Match History`;

    // 1. Find the ID for this Name using Players Sheet (A=ID, B=Name)
    const playerEntry = playersData.find(r => r[1] && r[1].trim() === playerName);
    if (!playerEntry) {
        modalBody.innerHTML = '<tr><td colspan="3">Player ID not found.</td></tr>';
        return;
    }
    const targetID = playerEntry[0].trim();

    // 2. Create an ID-to-Name Map for the Opponents
    const idToName = {};
    playersData.forEach(r => { if(r[0]) idToName[r[0].trim()] = r[1]; });

    // 3. Filter Schedule (Assume Schedule: A=Week, B=P1_ID, C=P2_ID, D=Win, E=Proc)
    let found = 0;
    scheduleData.slice(1).forEach(game => {
        let [week, p1ID, p2ID, p1win, processed] = game.map(col => col ? col.trim() : "");
        
        if (p1ID === targetID || p2ID === targetID) {
            found++;
            const isP1 = (p1ID === targetID);
            const opponentID = isP1 ? p2ID : p1ID;
            const opponentName = idToName[opponentID] || opponentID;

            let result = '<i>TBD</i>';
            if (processed.toUpperCase() === 'TRUE') {
                const p1DidWin = (p1win.toUpperCase() === 'TRUE');
                const playerDidWin = isP1 ? p1DidWin : !p1DidWin;
                result = playerDidWin ? '<span class="win">W</span>' : '<span class="loss">L</span>';
            }

            let tr = document.createElement('tr');
            tr.innerHTML = `<td>${week}</td><td>${opponentName}</td><td>${result}</td>`;
            modalBody.appendChild(tr);
        }
    });

    if (found === 0) modalBody.innerHTML = '<tr><td colspan="3">No games found in schedule.</td></tr>';

    document.getElementById('modal-overlay').style.display = 'block';
    document.getElementById('schedule-modal').style.display = 'block';
}

function closeModal() {
    document.getElementById('modal-overlay').style.display = 'none';
    document.getElementById('schedule-modal').style.display = 'none';
}

init();
