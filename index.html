<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crimson Cue Standings</title>
    <style>
        :root {
            --felt-green: #0a5d3e;
            --felt-dark: #07422c;
            --wood-brown: #3e2723;
            --text-color: #333;
        }

        body { font-family: 'Segoe UI', Arial, sans-serif; background-color: #f4f4f4; margin: 0; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        header { background-color: var(--wood-brown); color: white; width: 100%; max-width: 900px; padding: 20px; text-align: center; border-radius: 8px 8px 0 0; border-bottom: 5px solid var(--felt-green); }
        .container { background: white; width: 100%; max-width: 900px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-radius: 0 0 8px 8px; }
        h2 { color: var(--felt-green); border-bottom: 2px solid #eee; padding-bottom: 10px; }

        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th { background-color: var(--felt-green); color: white; padding: 12px; text-align: left; }
        td { padding: 12px; border-bottom: 1px solid #ddd; }
        #table-body tr { cursor: pointer; }
        #table-body tr:hover { background-color: #f1f1f1; }

        /* Updated Modal Styles */
        #modal-overlay { 
            display: none; 
            position: fixed; 
            top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.8); 
            z-index: 100; 
        }
        
        .modal-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            border-bottom: 2px solid var(--felt-green); 
            padding-bottom: 10px;
            margin-bottom: 10px;
            flex-shrink: 0; /* Prevents header from squishing */
        }
        
        #schedule-modal {
            display: none;
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 12px;
            z-index: 101;
            width: 90%;
            max-width: 400px;
            
            /* FIX: Set a hard limit and stop the modal itself from scrolling */
            height: auto;
            max-height: 70vh; 
            display: flex;
            flex-direction: column;
            overflow: hidden; /* This forces the scroll to happen inside, not outside */
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        
        .modal-scroll-container {
            /* FIX: Force this box to scroll if content exceeds the space */
            overflow-y: auto;
            flex: 1 1 auto; 
            min-height: 0; /* Crucial for flexbox scrolling */
            margin-top: 10px;
            border: 1px solid #eee;
        }
        
        #modal-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        #modal-table th {
            position: sticky;
            top: -1px; /* Slight offset ensures no gaps */
            background-color: var(--felt-green);
            color: white;
            padding: 10px;
            z-index: 10;
        }
        }
    </style>
</head>
<body>

    <header><h1>Crimson Cue</h1></header>

    <div class="container">
        <h2>Live Standings</h2>
        <div id="loader" class="loading">Fetching league data...</div>
        <table id="standings-table" style="display:none;">
            <thead><tr id="table-header"></tr></thead>
            <tbody id="table-body"></tbody>
        </table>
    </div>
    <div id="modal-overlay" onclick="closeModal()"></div>
    <div id="schedule-modal">
        <div class="modal-header">
            <h3 id="modal-title" style="margin:0;">Player Schedule</h3>
            <span style="cursor:pointer; font-size: 1.5rem;" onclick="closeModal()">Ã—</span>
        </div>
        <div class="modal-scroll-container"> <table id="modal-table">
                <thead>
                    <tr>
                        <th>Week</th>
                        <th>Opponent</th>
                        <th>Result</th>
                    </tr>
                </thead>
                <tbody id="modal-body"></tbody>
            </table>
        </div>
    </div>

    <script>
        const standingsUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT7I8Vhws-a0KiVfiAzXZFneeKXAAJj51zqtjOf9h2AOHh51RWfZwyFCMtWU6VpckdXYVpGj8l0fPRv/pub?gid=2132397504&single=true&output=csv';
        const scheduleUrl  = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT7I8Vhws-a0KiVfiAzXZFneeKXAAJj51zqtjOf9h2AOHh51RWfZwyFCMtWU6VpckdXYVpGj8l0fPRv/pub?gid=1315791574&single=true&output=csv';
        const playersUrl   = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT7I8Vhws-a0KiVfiAzXZFneeKXAAJj51zqtjOf9h2AOHh51RWfZwyFCMtWU6VpckdXYVpGj8l0fPRv/pub?gid=1493303522&single=true&output=csv';

        let scheduleData = [];
        let playersData = [];

        async function init() {
            try {
                const [stR, schR, plR] = await Promise.all([fetch(standingsUrl), fetch(scheduleUrl), fetch(playersUrl)]);
                const stText = await stR.text();
                const schText = await schR.text();
                const plText = await plR.text();

                const stRows = stText.split('\n').map(r => r.split(','));
                scheduleData = schText.split('\n').map(r => r.split(','));
                playersData = plText.split('\n').map(r => r.split(','));

                renderStandings(stRows);
            } catch (e) {
                document.getElementById('loader').textContent = "Error loading data.";
            }
        }

        function renderStandings(rows) {
            const tableHeader = document.getElementById('table-header');
            const tableBody = document.getElementById('table-body');
            
            // Header
            rows[0].forEach(h => {
                let th = document.createElement('th');
                th.textContent = h;
                tableHeader.appendChild(th);
            });

            // Rows
            rows.slice(1).forEach(row => {
                if (row.length < 2) return;
                let tr = document.createElement('tr');
                tr.onclick = () => openSchedule(row[0].trim());
                row.forEach(cell => {
                    let td = document.createElement('td');
                    td.textContent = cell;
                    tr.appendChild(td);
                });
                tableBody.appendChild(tr);
            });

            document.getElementById('loader').style.display = 'none';
            document.getElementById('standings-table').style.display = 'table';
        }

        function openSchedule(playerName) {
            const modalBody = document.getElementById('modal-body');
            document.getElementById('modal-title').textContent = playerName + "'s History";
            modalBody.innerHTML = '';

            // 1. Find ID from Name
            const pEntry = playersData.find(r => r[1] && r[1].trim() === playerName);
            if (!pEntry) return;
            const targetID = pEntry[0].trim();

            // 2. ID to Name Map
            const idMap = {};
            playersData.forEach(r => { if(r[0]) idMap[r[0].trim()] = r[1]; });

            // 3. Filter Schedule
            scheduleData.slice(1).forEach(game => {
                let [week, p1ID, p2ID, p1win, proc] = game.map(c => c ? c.trim() : "");
                if (p1ID === targetID || p2ID === targetID) {
                    const isP1 = (p1ID === targetID);
                    const oppName = idMap[isP1 ? p2ID : p1ID] || "Unknown";
                    let res = 'TBD';
                    if (proc.toUpperCase() === 'TRUE') {
                        const p1W = (p1win.toUpperCase() === 'TRUE');
                        res = (isP1 === p1W) ? '<span class="win">W</span>' : '<span class="loss">L</span>';
                    }
                    let tr = document.createElement('tr');
                    tr.innerHTML = `<td>${week}</td><td>${oppName}</td><td>${res}</td>`;
                    modalBody.appendChild(tr);
                }
            });

            document.getElementById('modal-overlay').style.display = 'block';
            document.getElementById('schedule-modal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('modal-overlay').style.display = 'none';
            document.getElementById('schedule-modal').style.display = 'none';
        }

        init();
    </script>
</body>
</html>
